

<!DOCTYPE html>
<html lang="zh-CN" data-default-color-scheme=auto>



<head>
  <meta charset="UTF-8">
  <link rel="apple-touch-icon" sizes="76x76" href="/img/favicon.jpg">
  <link rel="icon" href="/img/favicon.jpg">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, shrink-to-fit=no">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  
  <meta name="theme-color" content="#1C262C">
  <meta name="author" content="滑滑蛋">
  <meta name="keywords" content="">
  
    <meta name="description" content="引言lab3A的实验要求如下： Your first task is to implement a solution that works when there are no dropped messages, and no failed servers. You’ll need to add RPC-sending code to the Clerk Put&#x2F;Append&#x2F;G">
<meta property="og:type" content="article">
<meta property="og:title" content="【MIT6.824】lab3 Fault-tolerant Key&#x2F;Value Service 实现笔记">
<meta property="og:url" content="http://example.com/2024/04/08/MIT6-824lab3A3B/index.html">
<meta property="og:site_name" content="滑滑蛋的个人博客">
<meta property="og:description" content="引言lab3A的实验要求如下： Your first task is to implement a solution that works when there are no dropped messages, and no failed servers. You’ll need to add RPC-sending code to the Clerk Put&#x2F;Append&#x2F;G">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="http://example.com/2024/04/08/MIT6-824lab3A3B/result.jpg">
<meta property="article:published_time" content="2024-04-08T07:39:24.000Z">
<meta property="article:modified_time" content="2024-04-10T02:15:37.219Z">
<meta property="article:author" content="滑滑蛋">
<meta property="article:tag" content="分布式">
<meta property="article:tag" content="MIT6.824">
<meta property="article:tag" content="Go">
<meta name="twitter:card" content="summary_large_image">
<meta name="twitter:image" content="http://example.com/2024/04/08/MIT6-824lab3A3B/result.jpg">
  
  
  
  <title>【MIT6.824】lab3 Fault-tolerant Key/Value Service 实现笔记 - 滑滑蛋的个人博客</title>

  <link  rel="stylesheet" href="https://lib.baomitu.com/twitter-bootstrap/4.6.1/css/bootstrap.min.css" />



  <link  rel="stylesheet" href="https://lib.baomitu.com/github-markdown-css/4.0.0/github-markdown.min.css" />

  <link  rel="stylesheet" href="https://lib.baomitu.com/hint.css/2.7.0/hint.min.css" />

  <link  rel="stylesheet" href="https://lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.css" />



<!-- 主题依赖的图标库，不要自行修改 -->
<!-- Do not modify the link that theme dependent icons -->

<link rel="stylesheet" href="//at.alicdn.com/t/font_1749284_hj8rtnfg7um.css">



<link rel="stylesheet" href="//at.alicdn.com/t/font_1736178_lbnruvf0jn.css">


<link  rel="stylesheet" href="/css/main.css" />


  <link id="highlight-css" rel="stylesheet" href="/css/highlight.css" />
  
    <link id="highlight-css-dark" rel="stylesheet" href="/css/highlight-dark.css" />
  




  <script id="fluid-configs">
    var Fluid = window.Fluid || {};
    Fluid.ctx = Object.assign({}, Fluid.ctx)
    var CONFIG = {"hostname":"example.com","root":"/","version":"1.9.5","typing":{"enable":true,"typeSpeed":70,"cursorChar":"_","loop":false,"scope":[]},"anchorjs":{"enable":true,"element":"h1,h2,h3,h4,h5,h6","placement":"left","visible":"hover","icon":""},"progressbar":{"enable":true,"height_px":3,"color":"#29d","options":{"showSpinner":false,"trickleSpeed":100}},"code_language":{"enable":true,"default":"TEXT"},"copy_btn":true,"image_caption":{"enable":true},"image_zoom":{"enable":true,"img_url_replace":["",""]},"toc":{"enable":true,"placement":"right","headingSelector":"h1,h2,h3,h4,h5,h6","collapseDepth":0},"lazyload":{"enable":true,"loading_img":"/img/loading.gif","onlypost":false,"offset_factor":2},"web_analytics":{"enable":true,"follow_dnt":true,"baidu":"d38d21fca521d897798e5bdd940a90d0","google":{"measurement_id":null},"tencent":{"sid":null,"cid":null},"woyaola":null,"cnzz":null,"leancloud":{"app_id":"WMtHomhQYlrbIodTwoPU3gTY-MdYXbMMI","app_key":"pZeun9WfI1yaQrIoUbvTQrXv","server_url":null,"path":"window.location.pathname","ignore_local":false}},"search_path":"/local-search.xml","include_content_in_search":true};

    if (CONFIG.web_analytics.follow_dnt) {
      var dntVal = navigator.doNotTrack || window.doNotTrack || navigator.msDoNotTrack;
      Fluid.ctx.dnt = dntVal && (dntVal.startsWith('1') || dntVal.startsWith('yes') || dntVal.startsWith('on'));
    }
  </script>
  <script  src="/js/utils.js" ></script>
  <script  src="/js/color-schema.js" ></script>
  

  
    <!-- Baidu Analytics -->
    <script async>
      if (!Fluid.ctx.dnt) {
        var _hmt = _hmt || [];
        (function() {
          var hm = document.createElement("script");
          hm.src = "https://hm.baidu.com/hm.js?d38d21fca521d897798e5bdd940a90d0";
          var s = document.getElementsByTagName("script")[0];
          s.parentNode.insertBefore(hm, s);
        })();
      }
    </script>
  

  
    <!-- Google tag (gtag.js) -->
    <script async>
      if (!Fluid.ctx.dnt) {
        Fluid.utils.createScript("https://www.googletagmanager.com/gtag/js?id=", function() {
          window.dataLayer = window.dataLayer || [];
          function gtag() {
            dataLayer.push(arguments);
          }
          gtag('js', new Date());
          gtag('config', '');
        });
      }
    </script>
  

  

  

  

  
    
  



  
<meta name="generator" content="Hexo 7.0.0"></head>


<body>
  

  <header>
    

<div class="header-inner" style="height: 70vh;">
  <nav id="navbar" class="navbar fixed-top  navbar-expand-lg navbar-dark scrolling-navbar">
  <div class="container">
    <a class="navbar-brand" href="/">
      <strong>滑滑蛋</strong>
    </a>

    <button id="navbar-toggler-btn" class="navbar-toggler" type="button" data-toggle="collapse"
            data-target="#navbarSupportedContent"
            aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
      <div class="animated-icon"><span></span><span></span><span></span></div>
    </button>

    <!-- Collapsible content -->
    <div class="collapse navbar-collapse" id="navbarSupportedContent">
      <ul class="navbar-nav ml-auto text-center">
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/">
                <i class="iconfont icon-home-fill"></i>
                <span>首页</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/archives/">
                <i class="iconfont icon-archive-fill"></i>
                <span>归档</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/categories/">
                <i class="iconfont icon-category-fill"></i>
                <span>分类</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/tags/">
                <i class="iconfont icon-tags-fill"></i>
                <span>标签</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/about/">
                <i class="iconfont icon-user-fill"></i>
                <span>关于</span>
              </a>
            </li>
          
        
        
          <li class="nav-item" id="search-btn">
            <a class="nav-link" target="_self" href="javascript:;" data-toggle="modal" data-target="#modalSearch" aria-label="Search">
              <i class="iconfont icon-search"></i>
            </a>
          </li>
          
        
        
          <li class="nav-item" id="color-toggle-btn">
            <a class="nav-link" target="_self" href="javascript:;" aria-label="Color Toggle">
              <i class="iconfont icon-dark" id="color-toggle-icon"></i>
            </a>
          </li>
        
      </ul>
    </div>
  </div>
</nav>

  

<div id="banner" class="banner" parallax=true
     style="background: url('/img/default.png') no-repeat center center; background-size: cover;">
  <div class="full-bg-img">
    <div class="mask flex-center" style="background-color: rgba(0, 0, 0, 0.3)">
      <div class="banner-text text-center fade-in-up">
        <div class="h2">
          
            <span id="subtitle" data-typed-text="【MIT6.824】lab3 Fault-tolerant Key/Value Service 实现笔记"></span>
          
        </div>

        
          
  <div class="mt-3">
    
    
      <span class="post-meta">
        <i class="iconfont icon-date-fill" aria-hidden="true"></i>
        <time datetime="2024-04-08 15:39" pubdate>
          2024年4月8日 下午
        </time>
      </span>
    
  </div>

  <div class="mt-1">
    
      <span class="post-meta mr-2">
        <i class="iconfont icon-chart"></i>
        
          9.1k 字
        
      </span>
    

    
      <span class="post-meta mr-2">
        <i class="iconfont icon-clock-fill"></i>
        
        
        
          46 分钟
        
      </span>
    

    
    
      
        <span id="leancloud-page-views-container" class="post-meta" style="display: none">
          <i class="iconfont icon-eye" aria-hidden="true"></i>
          <span id="leancloud-page-views"></span> 次
        </span>
        
      
    
  </div>


        
      </div>

      
    </div>
  </div>
</div>

</div>

  </header>

  <main>
    
      

<div class="container-fluid nopadding-x">
  <div class="row nomargin-x">
    <div class="side-col d-none d-lg-block col-lg-2">
      

    </div>

    <div class="col-lg-8 nopadding-x-md">
      <div class="container nopadding-x-md" id="board-ctn">
        <div id="board">
          <article class="post-content mx-auto">
            <h1 id="seo-header">【MIT6.824】lab3 Fault-tolerant Key/Value Service 实现笔记</h1>
            
            
              <div class="markdown-body">
                
                <h1 id="引言"><a href="#引言" class="headerlink" title="引言"></a>引言</h1><p>lab3A的实验要求如下：</p>
<p>Your first task is to implement a solution that works when there are no dropped messages, and no failed servers.</p>
<p>You’ll need to add RPC-sending code to the Clerk Put&#x2F;Append&#x2F;Get methods in client.go, and implement PutAppend() and Get() RPC handlers in server.go. These handlers should enter an Op in the Raft log using Start(); you should fill in the Op struct definition in server.go so that it describes a Put&#x2F;Append&#x2F;Get operation. Each server should execute Op commands as Raft commits them, i.e. as they appear on the applyCh. An RPC handler should notice when Raft commits its Op, and then reply to the RPC.</p>
<p>You have completed this task when you reliably pass the first test in the test suite: “One client”.</p>
<p>Add code to handle failures, and to cope with duplicate Clerk requests, including situations where the Clerk sends a request to a kvserver leader in one term, times out waiting for a reply, and re-sends the request to a new leader in another term. The request should execute just once. These notes include guidance on duplicate detection. Your code should pass the go test -run 3A tests.</p>
<p>lab3B的实验要求如下：</p>
<p>Modify your kvserver so that it detects when the persisted Raft state grows too large, and then hands a snapshot to Raft. When a kvserver server restarts, it should read the snapshot from persister and restore its state from the snapshot.</p>
<p>总体而言，我们需要在lab2所实现的raft系统上构建一个简单的key-value存储系统，这个系统需要支持客户端的Put&#x2F;Append&#x2F;Get操作，同时需要支持Raft的持久化和快照功能。本系统的要求是线性一致的，即每个动作都能被当做是在一个唯一的时刻进行原子执行的，具体一致性相关的内容，可查看之前的文章：<a target="_blank" rel="noopener" href="https://slipegg.github.io/2024/03/28/linearizability/">分布式系统中的线性一致性</a>。<br>代码可以在<a target="_blank" rel="noopener" href="https://github.com/slipegg/MIT6.824">https://github.com/slipegg/MIT6.824</a>中得到。所有代码均通过了1千次的测试。</p>
<h1 id="lab3A-实现"><a href="#lab3A-实现" class="headerlink" title="lab3A 实现"></a>lab3A 实现</h1><p>lab3A不涉及到Raft的快照功能，主要是要完成整个系统功能的构建。在实验时测试3A时，测试代码将会不断调用客户端的Put&#x2F;Append&#x2F;Get操作，然后检查是否所有的操作都被正确执行。</p>
<p>首先通过一个map来存储key-value，如下中的KVMachine所示：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">type</span> KVMachine <span class="hljs-keyword">struct</span> &#123;<br>	KV <span class="hljs-keyword">map</span>[<span class="hljs-type">string</span>]<span class="hljs-type">string</span><br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(kv *KVMachine)</span></span> Get(key <span class="hljs-type">string</span>) (<span class="hljs-type">string</span>, Err) &#123;<br>	value, ok := kv.KV[key]<br>	<span class="hljs-keyword">if</span> !ok &#123;<br>		<span class="hljs-keyword">return</span> <span class="hljs-string">&quot;&quot;</span>, ErrNoKey<br>	&#125;<br>	<span class="hljs-keyword">return</span> value, OK<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(kv *KVMachine)</span></span> Put(key <span class="hljs-type">string</span>, value <span class="hljs-type">string</span>) Err &#123;<br>	kv.KV[key] = value<br>	<span class="hljs-keyword">return</span> OK<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(kv *KVMachine)</span></span> Append(key <span class="hljs-type">string</span>, value <span class="hljs-type">string</span>) Err &#123;<br>	oldValue, ok := kv.KV[key]<br>	<span class="hljs-keyword">if</span> !ok &#123;<br>		kv.KV[key] = value<br>		<span class="hljs-keyword">return</span> OK<br>	&#125;<br>	kv.KV[key] = oldValue + value<br>	<span class="hljs-keyword">return</span> OK<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">newKVMachine</span><span class="hljs-params">()</span></span> *KVMachine &#123;<br>	<span class="hljs-keyword">return</span> &amp;KVMachine&#123;<span class="hljs-built_in">make</span>(<span class="hljs-keyword">map</span>[<span class="hljs-type">string</span>]<span class="hljs-type">string</span>)&#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>然后是Client端的实现，首先Client在初始化时会随机生成一个数字当做自己的id，同时它也专门维护每个请求的唯一id。Client的Put&#x2F;Append&#x2F;Get操作都是通过RPC调用Server端的Put&#x2F;Append&#x2F;Get操作来实现的，如果Server端返回了错误，告诉当前Server不是leader，那么Client就会重新发送请求到下一个Server去，直到找到leader并执行请求成功了为止。Client端的PutAppend&#x2F;Get操作的实现如下，Get也是类似，就是错误处理稍微不同，不再赘述：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(ck *Clerk)</span></span> PutAppend(key <span class="hljs-type">string</span>, value <span class="hljs-type">string</span>, op <span class="hljs-type">string</span>) &#123;<br>	DPrintf(<span class="hljs-string">&quot;&#123;Clinetn-%d&#125; try to %s &#123;&#x27;%v&#x27;: &#x27;%v&#x27;&#125;\n&quot;</span>, ck.clientId, op, key, value)<br>	args := PutAppendArgs&#123;Key: key, Value: value, Op: op, ClientId: ck.clientId, RequestId: ck.requestId&#125;<br>	<span class="hljs-keyword">for</span> &#123;<br>		<span class="hljs-keyword">var</span> reply PutAppendReply<br>		<span class="hljs-keyword">if</span> ck.servers[ck.leaderId].Call(<span class="hljs-string">&quot;KVServer.PutAppend&quot;</span>, &amp;args, &amp;reply) &amp;&amp; reply.Err == OK &#123;<br>			DPrintf(<span class="hljs-string">&quot;&#123;Clinetn-%d&#125; %s &#123;&#x27;%v&#x27;: &#x27;%v&#x27;&#125; success\n&quot;</span>, ck.clientId, op, key, value)<br>			ck.requestId++<br>			<span class="hljs-keyword">break</span><br>		&#125; <span class="hljs-keyword">else</span> &#123;<br>			ck.leaderId = (ck.leaderId + <span class="hljs-number">1</span>) % <span class="hljs-type">int64</span>(<span class="hljs-built_in">len</span>(ck.servers))<br>			time.Sleep(<span class="hljs-number">100</span> * time.Millisecond)<br>		&#125;<br>	&#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>每个Server端都会维护一个KVMachine，并且也连接到一个专门的raft节点，它的主要作用就是将客户端的请求转化为raft节点的日志，然后等待raft节点将日志提交后接收到raft节点的信息，将日志应用到自己的KVMachine中，然后返回给客户端。</p>
<p>将客户端请求转化为日志传递给raft部分的代码如下,Get请求也是类似的。注意这里对于重复执行过的Put、Append会直接进行返回，因为运行结果只会是OK，所以直接返回OK即可，而Get请求不需要判断是否重复执行，因为Get请求需要获取的实最新的数据，来一次就执行一次即可。</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(kv *KVServer)</span></span> PutAppend(args *PutAppendArgs, reply *PutAppendReply) &#123;<br>	<span class="hljs-comment">// Your code here.</span><br>	<span class="hljs-keyword">defer</span> DPrintf(<span class="hljs-string">&quot;&#123;KVServer-%d&#125; finishes %s &#123;%s: %s&#125;, the reply is %v\n&quot;</span>, kv.me, args.Op, args.Key, args.Value, reply)<br>	kv.mu.RLock()<br>	<span class="hljs-keyword">if</span> kv.isDuplicate(args.ClientId, args.RequestId) &#123;<br>		kv.mu.RUnlock()<br>		reply.Err = OK<br>		<span class="hljs-keyword">return</span><br>	&#125;<br>	kv.mu.RUnlock()<br><br>	logId, _, isLeader := kv.rf.Start(Op&#123;PutAppendArgs: args&#125;)<br><br>	<span class="hljs-keyword">if</span> !isLeader &#123;<br>		reply.Err = ErrWrongLeader<br>		<span class="hljs-keyword">return</span><br>	&#125;<br><br>	DPrintf(<span class="hljs-string">&quot;&#123;KVServer-%d&#125; try to %s &#123;%s: %s&#125; with logId: %d\n&quot;</span>, kv.me, args.Op, args.Key, args.Value, logId)<br><br>	kv.mu.Lock()<br>	ch_putAppend := kv.getNotifyCh_PutAppend(logId)<br>	kv.mu.Unlock()<br><br>	<span class="hljs-keyword">select</span> &#123;<br>	<span class="hljs-keyword">case</span> result := &lt;-ch_putAppend:<br>		reply.Err = result.Err<br>	<span class="hljs-keyword">case</span> &lt;-time.After(MaxWaitTime):<br>		reply.Err = ErrTimeout<br>	&#125;<br><br>	<span class="hljs-keyword">go</span> <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">()</span></span> &#123;<br>		kv.mu.Lock()<br>		<span class="hljs-built_in">delete</span>(kv.notifyChs_PutAppend, logId)<br>		kv.mu.Unlock()<br>	&#125;()<br>&#125;<br></code></pre></td></tr></table></figure>

<p>当raft节点将日志分发给了大部分的节点后，就可以将日志提交，然后提醒Server端将日志应用到自己的KVMachine中。代码如下所示。注意对于Get请求，需要判断这时候节点是不是leader，Term是否还相同，以防止由于applyCh传递时间过长，这时候节点已经不是leader，没有最新的数据了。对于Put、Append操作需要判断是否已经是重复执行过的操作，如果是，直接标记为OK即可，不需要再次执行，同样也需要判断当前还是不是leader，如果是才有权限返回给客户端执行结果。</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(kv *KVServer)</span></span> applier() &#123;<br>	<span class="hljs-keyword">for</span> !kv.killed() &#123;<br>		<span class="hljs-keyword">select</span> &#123;<br>		<span class="hljs-keyword">case</span> msg := &lt;-kv.applyCh:<br>			<span class="hljs-keyword">if</span> msg.CommandValid &#123;<br>				kv.mu.Lock()<br>				<span class="hljs-keyword">if</span> msg.CommandIndex &lt;= kv.lastApplied &#123;<br>					DPrintf(<span class="hljs-string">&quot;&#123;KVServer-%d&#125; reveives applied log&#123;%v&#125;&quot;</span>, kv.me, msg)<br>					kv.mu.Unlock()<br>					<span class="hljs-keyword">continue</span><br>				&#125;<br>				kv.lastApplied = msg.CommandIndex<br><br>				op := msg.Command.(Op)<br>				<span class="hljs-keyword">if</span> op.GetArgs != <span class="hljs-literal">nil</span> &#123;<br>					DPrintf(<span class="hljs-string">&quot;&#123;KVServer-%d&#125; apply get %v.&quot;</span>, kv.me, op.GetArgs.Key)<br>					value, err := kv.kvMachine.Get(op.GetArgs.Key)<br>					reply := GetReply&#123;Err: err, Value: value&#125;<br><br>					<span class="hljs-keyword">if</span> currentTerm, isLeader := kv.rf.GetState(); isLeader &amp;&amp; currentTerm == msg.CommandTerm &#123;<br>						<span class="hljs-keyword">if</span> ch, ok := kv.notifyChs_Get[msg.CommandIndex]; ok &#123;<br>							ch &lt;- reply<br>						&#125;<br>					&#125;<br>				&#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> op.PutAppendArgs != <span class="hljs-literal">nil</span> &#123;<br>					<span class="hljs-keyword">var</span> reply PutAppendReply<br>					<span class="hljs-keyword">if</span> kv.isDuplicate(op.PutAppendArgs.ClientId, op.PutAppendArgs.RequestId) &#123;<br>						DPrintf(<span class="hljs-string">&quot;&#123;KVServer-%d&#125; receives duplicated request&#123;%v&#125;\n&quot;</span>, kv.me, msg)<br>						reply.Err = OK<br>					&#125; <span class="hljs-keyword">else</span> &#123;<br>						DPrintf(<span class="hljs-string">&quot;&#123;KVServer-%d&#125; apply %s &#123;%s: %s&#125;.\n&quot;</span>, kv.me, op.PutAppendArgs.Op, op.PutAppendArgs.Key, op.PutAppendArgs.Value)<br>						<span class="hljs-keyword">if</span> op.PutAppendArgs.Op == <span class="hljs-string">&quot;Put&quot;</span> &#123;<br>							reply.Err = kv.kvMachine.Put(op.PutAppendArgs.Key, op.PutAppendArgs.Value)<br>						&#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> op.PutAppendArgs.Op == <span class="hljs-string">&quot;Append&quot;</span> &#123;<br>							reply.Err = kv.kvMachine.Append(op.PutAppendArgs.Key, op.PutAppendArgs.Value)<br>						&#125;<br>						kv.lastPutAppendId[op.PutAppendArgs.ClientId] = op.PutAppendArgs.RequestId<br>					&#125;<br><br>					<span class="hljs-keyword">if</span> _, isLeader := kv.rf.GetState(); isLeader &#123;<br>						<span class="hljs-keyword">if</span> ch, ok := kv.notifyChs_PutAppend[msg.CommandIndex]; ok &#123;<br>							ch &lt;- reply<br>						&#125;<br>					&#125;<br>				&#125; <span class="hljs-keyword">else</span> &#123;<br>					DPrintf(<span class="hljs-string">&quot;&#123;KVServer-%d&#125; receives unknown command&#123;%v&#125;&quot;</span>, kv.me, msg)<br>				&#125;<br><br>				<span class="hljs-keyword">if</span> kv.isNeedSnapshot() &#123;<br>					DPrintf(<span class="hljs-string">&quot;&#123;KVServer-%d&#125; needs snapshot\n&quot;</span>, kv.me)<br>					kv.snapshot(msg.CommandIndex)<br>				&#125;<br>				kv.mu.Unlock()<br>			&#125; <br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<h1 id="lab3B-实现"><a href="#lab3B-实现" class="headerlink" title="lab3B 实现"></a>lab3B 实现</h1><p>这里主要需要实现Server的持久化和快照功能，每个Server有一个自己的persister，其结构如下：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">type</span> Persister <span class="hljs-keyword">struct</span> &#123;<br>	mu        sync.Mutex<br>	raftstate []<span class="hljs-type">byte</span><br>	snapshot  []<span class="hljs-type">byte</span><br>&#125;<br></code></pre></td></tr></table></figure>

<p>其中raftstate部分是raft节点存储自身持久化状态用的，而snapshot节点是用来给Server存储自身状态用的，包括了Server的KVMachine状态以及lastPutAppendId。在Server启动时，会从persister中读取raftstate和snapshot，然后根据raftstate来初始化raft节点，根据snapshot来初始化KVMachine和lastPutAppendId。代码如下所示：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(kv *KVServer)</span></span> reloadBySnapshot(snapshot []<span class="hljs-type">byte</span>) &#123;<br>	<span class="hljs-keyword">if</span> snapshot == <span class="hljs-literal">nil</span> || <span class="hljs-built_in">len</span>(snapshot) &lt; <span class="hljs-number">1</span> &#123;<br>		<span class="hljs-keyword">return</span><br>	&#125;<br><br>	<span class="hljs-keyword">var</span> kvMachine KVMachine<br>	<span class="hljs-keyword">var</span> lastPutAppendId <span class="hljs-keyword">map</span>[<span class="hljs-type">int64</span>]<span class="hljs-type">int64</span><br><br>	r := bytes.NewBuffer(snapshot)<br>	d := labgob.NewDecoder(r)<br>	<span class="hljs-keyword">if</span> d.Decode(&amp;kvMachine) != <span class="hljs-literal">nil</span> ||<br>		d.Decode(&amp;lastPutAppendId) != <span class="hljs-literal">nil</span> &#123;<br>		DPrintf(<span class="hljs-string">&quot;&#123;KVServer-%d&#125; reloadBySnapshot failed\n&quot;</span>, kv.me)<br>	&#125;<br><br>	DPrintf(<span class="hljs-string">&quot;&#123;KVServer-%d&#125; reloadBySnapshot succeeded\n&quot;</span>, kv.me)<br>	kv.lastPutAppendId = lastPutAppendId<br>	kv.kvMachine = kvMachine<br>&#125;<br></code></pre></td></tr></table></figure>

<p>当Server在apply节点时，按照要求，如果raft的日志信息过大，就触发快照功能，将Server的状态保存到snapshot中，同时让raft节点生成快照。如下所示：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(kv *KVServer)</span></span> snapshot(lastAppliedLogId <span class="hljs-type">int</span>) &#123;<br>	w := <span class="hljs-built_in">new</span>(bytes.Buffer)<br>	e := labgob.NewEncoder(w)<br>	<span class="hljs-keyword">if</span> mr, lr := e.Encode(kv.kvMachine), e.Encode(kv.lastPutAppendId); mr != <span class="hljs-literal">nil</span> ||<br>		lr != <span class="hljs-literal">nil</span> &#123;<br>		DPrintf(<span class="hljs-string">&quot;&#123;KVServer-%d&#125; snapshot failed. kvMachine length: %v, result: &#123;%v&#125;, lastPutAppendId: &#123;%v&#125;, result: &#123;%v&#125;,&quot;</span>,<br>			kv.me, <span class="hljs-built_in">len</span>(kv.kvMachine.KV), mr, kv.lastPutAppendId, lr)<br>		<span class="hljs-keyword">return</span><br>	&#125;<br><br>	data := w.Bytes()<br>	kv.rf.Snapshot(lastAppliedLogId, data)<br>	DPrintf(<span class="hljs-string">&quot;&#123;KVServer-%d&#125; snapshot succeeded\n&quot;</span>, kv.me)<br>&#125;<br></code></pre></td></tr></table></figure>

<p>由于快照的引入，Server也可能需要apply快照，即对上述的applier函数再多加一个msg类型的判断，如下所示：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> msg.SnapshotValid &#123;<br>				kv.mu.Lock()<br>				kv.reloadBySnapshot(msg.Snapshot)<br>				kv.lastApplied = msg.CommandIndex<br>				kv.mu.Unlock()<br>			&#125;<br></code></pre></td></tr></table></figure>

<h1 id="相关问题"><a href="#相关问题" class="headerlink" title="相关问题"></a>相关问题</h1><h2 id="为什么Get操作不能直接读leader的本地数据？"><a href="#为什么Get操作不能直接读leader的本地数据？" class="headerlink" title="为什么Get操作不能直接读leader的本地数据？"></a>为什么Get操作不能直接读leader的本地数据？</h2><p>在Raft系统中，当面临网络分区情况时，原本的leader如果位于一个小分区，那么他就不知道其实大分区中已经有了一个新leader了，这样如果client还是连接的原本的leader，并且是直接读取该leader的本地数据，那么就会面临读取到过时数据的问题，导致系统线性不一致。</p>
<p>所以解决这个问题的关键在于确定节点真的是leader，这里采取的是一个简单的方法，即将这个Get操作作为一个log日志放入raft系统中，直到raft系统将这个log日志提交后，才返回。实际上还有优化的空间，一个方法是在raft接受到了一个Get操作后，立刻执行心跳，如果接收到了过半的节点的心跳回复，那么就证明了这个节点是真的leader，这样就可以直接返回数据了，这就避免了将Get操作放入raft系统中的开销。还有一种方法是叫做Lease Read，它的吞吐更大，详情可参考<a target="_blank" rel="noopener" href="https://blog.mrcroxx.com/posts/code-reading/etcdraft-made-simple/6-readonly/">深入浅出etcd&#x2F;raft —— 0x06 只读请求优化</a>。</p>
<h2 id="applier中是否有机会出现重复执行的put、append操作？"><a href="#applier中是否有机会出现重复执行的put、append操作？" class="headerlink" title="applier中是否有机会出现重复执行的put、append操作？"></a>applier中是否有机会出现重复执行的put、append操作？</h2><p>有机会出现。例如当客户端发送后，Server将其提交给了Raft，但是Raft没有在规定时间内返回，那么就会返回超时，然后客户端再去循环提交一轮，再一次提交给这个节点的时候，节点此时可能还是没有收到Raft的返回，所以会再次提交给Raft，这样就会出现重复提交的情况。而在applier中就会只执行第一次提交的操作，后续的提交都会被忽略。</p>
<h2 id="只用lastPutAppendId记录最后一次的Put、Append操作的id是否可行？"><a href="#只用lastPutAppendId记录最后一次的Put、Append操作的id是否可行？" class="headerlink" title="只用lastPutAppendId记录最后一次的Put、Append操作的id是否可行？"></a>只用lastPutAppendId记录最后一次的Put、Append操作的id是否可行？</h2><p>可行。因为系统中Put、Append操作的结果只会是ok，所以不需要记录每次的Put、Append操作的id，同时由于raft系统中一旦apply了就是永久apply了，并且前面的操作也都apply了，不存在回退的情况，所以如果当前操作的id小于最新一次Put、Append操作的id，那么就说明是重复执行了，直接返回ok即可。</p>
<h1 id="运行结果"><a href="#运行结果" class="headerlink" title="运行结果"></a>运行结果</h1><p>代码通过了1k次的测试，如下图所示。</p>
<p><img src="/2024/04/08/MIT6-824lab3A3B/result.jpg" srcset="/img/loading.gif" lazyload alt="测试结果"></p>
<h1 id="参考资料"><a href="#参考资料" class="headerlink" title="参考资料"></a>参考资料</h1><ul>
<li><a target="_blank" rel="noopener" href="https://blog.mrcroxx.com/posts/code-reading/etcdraft-made-simple/6-readonly/">深入浅出etcd&#x2F;raft —— 0x06 只读请求优化</a></li>
</ul>

                
              </div>
            
            <hr/>
            <div>
              <div class="post-metas my-3">
  
    <div class="post-meta mr-3 d-flex align-items-center">
      <i class="iconfont icon-category"></i>
      

<span class="category-chains">
  
  
    
      <span class="category-chain">
        
  <a href="/categories/MIT6-824/" class="category-chain-item">MIT6.824</a>
  
  
    <span>></span>
    
  <a href="/categories/MIT6-824/Lab/" class="category-chain-item">Lab</a>
  
  

  

      </span>
    
  
</span>

    </div>
  
  
    <div class="post-meta">
      <i class="iconfont icon-tags"></i>
      
        <a href="/tags/%E5%88%86%E5%B8%83%E5%BC%8F/" class="print-no-link">#分布式</a>
      
        <a href="/tags/MIT6-824/" class="print-no-link">#MIT6.824</a>
      
        <a href="/tags/Go/" class="print-no-link">#Go</a>
      
    </div>
  
</div>


              
  

  <div class="license-box my-3">
    <div class="license-title">
      <div>【MIT6.824】lab3 Fault-tolerant Key/Value Service 实现笔记</div>
      <div>http://example.com/2024/04/08/MIT6-824lab3A3B/</div>
    </div>
    <div class="license-meta">
      
        <div class="license-meta-item">
          <div>作者</div>
          <div>滑滑蛋</div>
        </div>
      
      
        <div class="license-meta-item license-meta-date">
          <div>发布于</div>
          <div>2024年4月8日</div>
        </div>
      
      
      
        <div class="license-meta-item">
          <div>许可协议</div>
          <div>
            
              
              
                <a class="print-no-link" target="_blank" href="https://creativecommons.org/licenses/by/4.0/">
                  <span class="hint--top hint--rounded" aria-label="BY - 署名">
                    <i class="iconfont icon-by"></i>
                  </span>
                </a>
              
            
          </div>
        </div>
      
    </div>
    <div class="license-icon iconfont"></div>
  </div>



              
                <div class="post-prevnext my-3">
                  <article class="post-prev col-6">
                    
                    
                      <a href="/2024/04/18/DockerStudy/" title="万字总结！Docker简介及底层关键技术剖析">
                        <i class="iconfont icon-arrowleft"></i>
                        <span class="hidden-mobile">万字总结！Docker简介及底层关键技术剖析</span>
                        <span class="visible-mobile">上一篇</span>
                      </a>
                    
                  </article>
                  <article class="post-next col-6">
                    
                    
                      <a href="/2024/04/08/MIT6-824lab2C2D/" title="【MIT6.824】lab2C-persistence, lab2D-log compaction 实现笔记">
                        <span class="hidden-mobile">【MIT6.824】lab2C-persistence, lab2D-log compaction 实现笔记</span>
                        <span class="visible-mobile">下一篇</span>
                        <i class="iconfont icon-arrowright"></i>
                      </a>
                    
                  </article>
                </div>
              
            </div>

            
  
  
    <article id="comments" lazyload>
      
  <div id="valine"></div>
  <script type="text/javascript">
    Fluid.utils.loadComments('#valine', function() {
      Fluid.utils.createScript('https://lib.baomitu.com/valine/1.5.1/Valine.min.js', function() {
        var options = Object.assign(
          {"appId":"WMtHomhQYlrbIodTwoPU3gTY-MdYXbMMI","appKey":"pZeun9WfI1yaQrIoUbvTQrXv","path":"window.location.pathname","placeholder":null,"avatar":"retro","meta":["nick","mail","link"],"requiredFields":[],"pageSize":10,"lang":"zh-CN","highlight":false,"recordIP":false,"serverURLs":"https://wmthomhq.api.lncldglobal.com","emojiCDN":null,"emojiMaps":null,"enableQQ":false},
          {
            el: "#valine",
            path: window.location.pathname
          }
        )
        new Valine(options);
        Fluid.utils.waitElementVisible('#valine .vcontent', () => {
          var imgSelector = '#valine .vcontent img:not(.vemoji)';
          Fluid.plugins.imageCaption(imgSelector);
          Fluid.plugins.fancyBox(imgSelector);
        })
      });
    });
  </script>
  <noscript>Please enable JavaScript to view the comments</noscript>


    </article>
  


          </article>
        </div>
      </div>
    </div>

    <div class="side-col d-none d-lg-block col-lg-2">
      
  <aside class="sidebar" style="margin-left: -1rem">
    <div id="toc">
  <p class="toc-header">
    <i class="iconfont icon-list"></i>
    <span>目录</span>
  </p>
  <div class="toc-body" id="toc-body"></div>
</div>



  </aside>


    </div>
  </div>
</div>





  



  



  



  



  







    

    
      <a id="scroll-top-button" aria-label="TOP" href="#" role="button">
        <i class="iconfont icon-arrowup" aria-hidden="true"></i>
      </a>
    

    
      <div class="modal fade" id="modalSearch" tabindex="-1" role="dialog" aria-labelledby="ModalLabel"
     aria-hidden="true">
  <div class="modal-dialog modal-dialog-scrollable modal-lg" role="document">
    <div class="modal-content">
      <div class="modal-header text-center">
        <h4 class="modal-title w-100 font-weight-bold">搜索</h4>
        <button type="button" id="local-search-close" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body mx-3">
        <div class="md-form mb-5">
          <input type="text" id="local-search-input" class="form-control validate">
          <label data-error="x" data-success="v" for="local-search-input">关键词</label>
        </div>
        <div class="list-group" id="local-search-result"></div>
      </div>
    </div>
  </div>
</div>

    

    
  </main>

  <footer>
    <div class="footer-inner">
  
    <div class="footer-content">
       <a href="https://hexo.io" target="_blank" rel="nofollow noopener"><span>Hexo</span></a> <i class="iconfont icon-love"></i> <a href="https://github.com/fluid-dev/hexo-theme-fluid" target="_blank" rel="nofollow noopener"><span>Fluid</span></a> 
    </div>
  
  
    <div class="statistics">
  
  

  
    
      <span id="leancloud-site-pv-container" style="display: none">
        总访问量 
        <span id="leancloud-site-pv"></span>
         次
      </span>
    
    
      <span id="leancloud-site-uv-container" style="display: none">
        总访客数 
        <span id="leancloud-site-uv"></span>
         次
      </span>
    
    

  
</div>

  
  
  
</div>

  </footer>

  <!-- Scripts -->
  
  <script  src="https://lib.baomitu.com/nprogress/0.2.0/nprogress.min.js" ></script>
  <link  rel="stylesheet" href="https://lib.baomitu.com/nprogress/0.2.0/nprogress.min.css" />

  <script>
    NProgress.configure({"showSpinner":false,"trickleSpeed":100})
    NProgress.start()
    window.addEventListener('load', function() {
      NProgress.done();
    })
  </script>


<script  src="https://lib.baomitu.com/jquery/3.6.4/jquery.min.js" ></script>
<script  src="https://lib.baomitu.com/twitter-bootstrap/4.6.1/js/bootstrap.min.js" ></script>
<script  src="/js/events.js" ></script>
<script  src="/js/plugins.js" ></script>


  <script  src="https://lib.baomitu.com/typed.js/2.0.12/typed.min.js" ></script>
  <script>
    (function (window, document) {
      var typing = Fluid.plugins.typing;
      var subtitle = document.getElementById('subtitle');
      if (!subtitle || !typing) {
        return;
      }
      var text = subtitle.getAttribute('data-typed-text');
      
        typing(text);
      
    })(window, document);
  </script>




  
    <script  src="/js/img-lazyload.js" ></script>
  




  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/tocbot/4.20.1/tocbot.min.js', function() {
    var toc = jQuery('#toc');
    if (toc.length === 0 || !window.tocbot) { return; }
    var boardCtn = jQuery('#board-ctn');
    var boardTop = boardCtn.offset().top;

    window.tocbot.init(Object.assign({
      tocSelector     : '#toc-body',
      contentSelector : '.markdown-body',
      linkClass       : 'tocbot-link',
      activeLinkClass : 'tocbot-active-link',
      listClass       : 'tocbot-list',
      isCollapsedClass: 'tocbot-is-collapsed',
      collapsibleClass: 'tocbot-is-collapsible',
      scrollSmooth    : true,
      includeTitleTags: true,
      headingsOffset  : -boardTop,
    }, CONFIG.toc));
    if (toc.find('.toc-list-item').length > 0) {
      toc.css('visibility', 'visible');
    }

    Fluid.events.registerRefreshCallback(function() {
      if ('tocbot' in window) {
        tocbot.refresh();
        var toc = jQuery('#toc');
        if (toc.length === 0 || !tocbot) {
          return;
        }
        if (toc.find('.toc-list-item').length > 0) {
          toc.css('visibility', 'visible');
        }
      }
    });
  });
</script>


  <script src=https://lib.baomitu.com/clipboard.js/2.0.11/clipboard.min.js></script>

  <script>Fluid.plugins.codeWidget();</script>


  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/anchor-js/4.3.1/anchor.min.js', function() {
    window.anchors.options = {
      placement: CONFIG.anchorjs.placement,
      visible  : CONFIG.anchorjs.visible
    };
    if (CONFIG.anchorjs.icon) {
      window.anchors.options.icon = CONFIG.anchorjs.icon;
    }
    var el = (CONFIG.anchorjs.element || 'h1,h2,h3,h4,h5,h6').split(',');
    var res = [];
    for (var item of el) {
      res.push('.markdown-body > ' + item.trim());
    }
    if (CONFIG.anchorjs.placement === 'left') {
      window.anchors.options.class = 'anchorjs-link-left';
    }
    window.anchors.add(res.join(', '));

    Fluid.events.registerRefreshCallback(function() {
      if ('anchors' in window) {
        anchors.removeAll();
        var el = (CONFIG.anchorjs.element || 'h1,h2,h3,h4,h5,h6').split(',');
        var res = [];
        for (var item of el) {
          res.push('.markdown-body > ' + item.trim());
        }
        if (CONFIG.anchorjs.placement === 'left') {
          anchors.options.class = 'anchorjs-link-left';
        }
        anchors.add(res.join(', '));
      }
    });
  });
</script>


  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.js', function() {
    Fluid.plugins.fancyBox();
  });
</script>


  <script>Fluid.plugins.imageCaption();</script>

  <script defer src="/js/leancloud.js" ></script>

  <script  src="/js/local-search.js" ></script>





<!-- 主题的启动项，将它保持在最底部 -->
<!-- the boot of the theme, keep it at the bottom -->
<script  src="/js/boot.js" ></script>


  

  <noscript>
    <div class="noscript-warning">博客在允许 JavaScript 运行的环境下浏览效果更佳</div>
  </noscript>
</body>
</html>
